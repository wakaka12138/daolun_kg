<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">

<title>class Gem::SafeMarshal::Visitors::ToRuby - Documentation for Ruby 3.3</title>

<script type="text/javascript">
  var rdoc_rel_prefix = "../../../";
  var index_rel_prefix = "../../../";
</script>

<script src="../../../js/navigation.js" defer></script>
<script src="../../../js/search.js" defer></script>
<script src="../../../js/search_index.js" defer></script>
<script src="../../../js/searcher.js" defer></script>
<script src="../../../js/darkfish.js" defer></script>

<link href="../../../css/fonts.css" rel="stylesheet">
<link href="../../../css/rdoc.css" rel="stylesheet">


<body id="top" role="document" class="class">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="../../../index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="../../../table_of_contents.html#pages">Pages</a>
    <a href="../../../table_of_contents.html#classes">Classes</a>
    <a href="../../../table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search (/) for a class, method, ..." spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  

  <div id="class-metadata">
    
    
<div id="parent-class-section" class="nav-section">
  <h3>Parent</h3>

  <p class="link">Visitor
</div>

    
    
    
<!-- Method Quickref -->
<div id="method-list-section" class="nav-section">
  <h3>Methods</h3>

  <ul class="link-list" role="directory">
    <li ><a href="#method-c-new">::new</a>
    <li ><a href="#method-i-call_method">#call_method</a>
    <li ><a href="#method-i-formatted_stack">#formatted_stack</a>
    <li ><a href="#method-i-map_ivars">#map_ivars</a>
    <li ><a href="#method-i-push_stack">#push_stack</a>
    <li ><a href="#method-i-register_object">#register_object</a>
    <li ><a href="#method-i-resolve_class">#resolve_class</a>
    <li ><a href="#method-i-resolve_ivar">#resolve_ivar</a>
    <li ><a href="#method-i-resolve_symbol_name">#resolve_symbol_name</a>
    <li class="calls-super" ><a href="#method-i-visit">#visit</a>
    <li ><a href="#method-i-visit_Gem_SafeMarshal_Elements_Array">#visit_Gem_SafeMarshal_Elements_Array</a>
    <li ><a href="#method-i-visit_Gem_SafeMarshal_Elements_Bignum">#visit_Gem_SafeMarshal_Elements_Bignum</a>
    <li ><a href="#method-i-visit_Gem_SafeMarshal_Elements_False">#visit_Gem_SafeMarshal_Elements_False</a>
    <li ><a href="#method-i-visit_Gem_SafeMarshal_Elements_Float">#visit_Gem_SafeMarshal_Elements_Float</a>
    <li ><a href="#method-i-visit_Gem_SafeMarshal_Elements_Hash">#visit_Gem_SafeMarshal_Elements_Hash</a>
    <li ><a href="#method-i-visit_Gem_SafeMarshal_Elements_HashWithDefaultValue">#visit_Gem_SafeMarshal_Elements_HashWithDefaultValue</a>
    <li ><a href="#method-i-visit_Gem_SafeMarshal_Elements_Integer">#visit_Gem_SafeMarshal_Elements_Integer</a>
    <li ><a href="#method-i-visit_Gem_SafeMarshal_Elements_Nil">#visit_Gem_SafeMarshal_Elements_Nil</a>
    <li ><a href="#method-i-visit_Gem_SafeMarshal_Elements_Object">#visit_Gem_SafeMarshal_Elements_Object</a>
    <li ><a href="#method-i-visit_Gem_SafeMarshal_Elements_ObjectLink">#visit_Gem_SafeMarshal_Elements_ObjectLink</a>
    <li ><a href="#method-i-visit_Gem_SafeMarshal_Elements_String">#visit_Gem_SafeMarshal_Elements_String</a>
    <li ><a href="#method-i-visit_Gem_SafeMarshal_Elements_Symbol">#visit_Gem_SafeMarshal_Elements_Symbol</a>
    <li ><a href="#method-i-visit_Gem_SafeMarshal_Elements_SymbolLink">#visit_Gem_SafeMarshal_Elements_SymbolLink</a>
    <li ><a href="#method-i-visit_Gem_SafeMarshal_Elements_True">#visit_Gem_SafeMarshal_Elements_True</a>
    <li ><a href="#method-i-visit_Gem_SafeMarshal_Elements_UserClass">#visit_Gem_SafeMarshal_Elements_UserClass</a>
    <li ><a href="#method-i-visit_Gem_SafeMarshal_Elements_UserDefined">#visit_Gem_SafeMarshal_Elements_UserDefined</a>
    <li ><a href="#method-i-visit_Gem_SafeMarshal_Elements_UserMarshal">#visit_Gem_SafeMarshal_Elements_UserMarshal</a>
    <li ><a href="#method-i-visit_Gem_SafeMarshal_Elements_WithIvars">#visit_Gem_SafeMarshal_Elements_WithIvars</a>
    <li ><a href="#method-i-visit_symbol_type">#visit_symbol_type</a>
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-labelledby="class-Gem::SafeMarshal::Visitors::ToRuby">
  <h1 id="class-Gem::SafeMarshal::Visitors::ToRuby" class="class">
    class Gem::SafeMarshal::Visitors::ToRuby
  </h1>

  <section class="description">
    
  </section>

  <section id="5Buntitled-5D" class="documentation-section">


    <section class="constants-list">
      <header>
        <h3>Constants</h3>
      </header>
      <dl>
        <dt id="COMPAT_CLASSES">COMPAT_CLASSES
        <dd>
      </dl>
    </section>



     <section id="public-class-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Class Methods</h3>
       </header>

      <div id="method-c-new" class="method-detail ">
        <div class="method-header">
          <div class="method-heading">
            <span class="method-name">new</span><span
              class="method-args">(permitted_classes:, permitted_symbols:, permitted_ivars:)</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
        </div>

        <div class="method-description">
          

          <div class="method-source-code" id="new-source">
            <pre><span class="ruby-comment"># File lib/rubygems/safe_marshal/visitors/to_ruby.rb, line 8</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">initialize</span>(<span class="ruby-value">permitted_classes:</span>, <span class="ruby-value">permitted_symbols:</span>, <span class="ruby-value">permitted_ivars:</span>)
  <span class="ruby-ivar">@permitted_classes</span> = <span class="ruby-identifier">permitted_classes</span>
  <span class="ruby-ivar">@permitted_symbols</span> = [<span class="ruby-string">&quot;E&quot;</span>].<span class="ruby-identifier">concat</span>(<span class="ruby-identifier">permitted_symbols</span>).<span class="ruby-identifier">concat</span>(<span class="ruby-identifier">permitted_classes</span>)
  <span class="ruby-ivar">@permitted_ivars</span> = <span class="ruby-identifier">permitted_ivars</span>

  <span class="ruby-ivar">@objects</span> = []
  <span class="ruby-ivar">@symbols</span> = []
  <span class="ruby-ivar">@class_cache</span> = {}

  <span class="ruby-ivar">@stack</span> = [<span class="ruby-string">&quot;root&quot;</span>]
  <span class="ruby-ivar">@stack_idx</span> = <span class="ruby-value">1</span>
<span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

    </section>

     <section id="public-instance-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Instance Methods</h3>
       </header>

      <div id="method-i-visit" class="method-detail ">
        <div class="method-header">
          <div class="method-heading">
            <span class="method-name">visit</span><span
              class="method-args">(target)</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
        </div>

        <div class="method-description">
          
            <div class="method-calls-super">
              Calls superclass method
              
            </div>

          <div class="method-source-code" id="visit-source">
            <pre><span class="ruby-comment"># File lib/rubygems/safe_marshal/visitors/to_ruby.rb, line 26</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">visit</span>(<span class="ruby-identifier">target</span>)
  <span class="ruby-identifier">stack_idx</span> = <span class="ruby-ivar">@stack_idx</span>
  <span class="ruby-keyword">super</span>
<span class="ruby-keyword">ensure</span>
  <span class="ruby-ivar">@stack_idx</span> = <span class="ruby-identifier">stack_idx</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>
<span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

    </section>

     <section id="private-instance-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Private Instance Methods</h3>
       </header>

      <div id="method-i-call_method" class="method-detail ">
        <div class="method-header">
          <div class="method-heading">
            <span class="method-name">call_method</span><span
              class="method-args">(receiver, method, *args)</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
        </div>

        <div class="method-description">
          

          <div class="method-source-code" id="call_method-source">
            <pre><span class="ruby-comment"># File lib/rubygems/safe_marshal/visitors/to_ruby.rb, line 350</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">call_method</span>(<span class="ruby-identifier">receiver</span>, <span class="ruby-identifier">method</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">args</span>)
  <span class="ruby-identifier">receiver</span>.<span class="ruby-identifier">__send__</span>(<span class="ruby-identifier">method</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">args</span>)
<span class="ruby-keyword">rescue</span> <span class="ruby-constant">NoMethodError</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">e</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">e</span>.<span class="ruby-identifier">receiver</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">receiver</span>

  <span class="ruby-identifier">raise</span> <span class="ruby-constant">MethodCallError</span>, <span class="ruby-node">&quot;Unable to call #{method.inspect} on #{receiver.inspect}, perhaps it is a class using marshal compat, which is not visible in ruby? #{e}&quot;</span>
<span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

      <div id="method-i-formatted_stack" class="method-detail ">
        <div class="method-header">
          <div class="method-heading">
            <span class="method-name">formatted_stack</span><span
              class="method-args">()</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
        </div>

        <div class="method-description">
          

          <div class="method-source-code" id="formatted_stack-source">
            <pre><span class="ruby-comment"># File lib/rubygems/safe_marshal/visitors/to_ruby.rb, line 358</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">formatted_stack</span>
  <span class="ruby-identifier">formatted</span> = []
  <span class="ruby-ivar">@stack</span>[<span class="ruby-value">0</span>, <span class="ruby-ivar">@stack_idx</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">e</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">e</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Integer</span>)
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">formatted</span>.<span class="ruby-identifier">last</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;ivar_&quot;</span>
        <span class="ruby-identifier">formatted</span>[<span class="ruby-value">-1</span>] = <span class="ruby-node">&quot;ivar_#{e}&quot;</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">formatted</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;[#{e}]&quot;</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">formatted</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">e</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">formatted</span>
<span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

      <div id="method-i-map_ivars" class="method-detail ">
        <div class="method-header">
          <div class="method-heading">
            <span class="method-name">map_ivars</span><span
              class="method-args">(klass, ivars)</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
        </div>

        <div class="method-description">
          

          <div class="method-source-code" id="map_ivars-source">
            <pre><span class="ruby-comment"># File lib/rubygems/safe_marshal/visitors/to_ruby.rb, line 63</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">map_ivars</span>(<span class="ruby-identifier">klass</span>, <span class="ruby-identifier">ivars</span>)
  <span class="ruby-identifier">stack_idx</span> = <span class="ruby-ivar">@stack_idx</span>
  <span class="ruby-identifier">ivars</span>.<span class="ruby-identifier">map</span>.<span class="ruby-identifier">with_index</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span>(<span class="ruby-identifier">k</span>, <span class="ruby-identifier">v</span>), <span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
    <span class="ruby-ivar">@stack_idx</span> = <span class="ruby-identifier">stack_idx</span>

    <span class="ruby-identifier">push_stack</span> <span class="ruby-string">&quot;ivar_&quot;</span>
    <span class="ruby-identifier">push_stack</span> <span class="ruby-identifier">i</span>
    <span class="ruby-identifier">k</span> = <span class="ruby-identifier">resolve_ivar</span>(<span class="ruby-identifier">klass</span>, <span class="ruby-identifier">k</span>)

    <span class="ruby-ivar">@stack_idx</span> = <span class="ruby-identifier">stack_idx</span>
    <span class="ruby-identifier">push_stack</span> <span class="ruby-identifier">k</span>

    <span class="ruby-keyword">next</span> <span class="ruby-identifier">k</span>, <span class="ruby-identifier">visit</span>(<span class="ruby-identifier">v</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

      <div id="method-i-push_stack" class="method-detail ">
        <div class="method-header">
          <div class="method-heading">
            <span class="method-name">push_stack</span><span
              class="method-args">(element)</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
        </div>

        <div class="method-description">
          

          <div class="method-source-code" id="push_stack-source">
            <pre><span class="ruby-comment"># File lib/rubygems/safe_marshal/visitors/to_ruby.rb, line 35</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">push_stack</span>(<span class="ruby-identifier">element</span>)
  <span class="ruby-ivar">@stack</span>[<span class="ruby-ivar">@stack_idx</span>] = <span class="ruby-identifier">element</span>
  <span class="ruby-ivar">@stack_idx</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
<span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

      <div id="method-i-register_object" class="method-detail ">
        <div class="method-header">
          <div class="method-heading">
            <span class="method-name">register_object</span><span
              class="method-args">(o)</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
        </div>

        <div class="method-description">
          

          <div class="method-source-code" id="register_object-source">
            <pre><span class="ruby-comment"># File lib/rubygems/safe_marshal/visitors/to_ruby.rb, line 345</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">register_object</span>(<span class="ruby-identifier">o</span>)
  <span class="ruby-ivar">@objects</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">o</span>
  <span class="ruby-identifier">o</span>
<span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

      <div id="method-i-resolve_class" class="method-detail ">
        <div class="method-header">
          <div class="method-heading">
            <span class="method-name">resolve_class</span><span
              class="method-args">(n)</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
        </div>

        <div class="method-description">
          

          <div class="method-source-code" id="resolve_class-source">
            <pre><span class="ruby-comment"># File lib/rubygems/safe_marshal/visitors/to_ruby.rb, line 274</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">resolve_class</span>(<span class="ruby-identifier">n</span>)
  <span class="ruby-ivar">@class_cache</span>[<span class="ruby-identifier">n</span>] <span class="ruby-operator">||=</span> <span class="ruby-keyword">begin</span>
    <span class="ruby-identifier">to_s</span> = <span class="ruby-identifier">resolve_symbol_name</span>(<span class="ruby-identifier">n</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">UnpermittedClassError</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value">name:</span> <span class="ruby-identifier">to_s</span>, <span class="ruby-value">stack:</span> <span class="ruby-identifier">formatted_stack</span>) <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@permitted_classes</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">to_s</span>)
    <span class="ruby-identifier">visit_symbol_type</span>(<span class="ruby-identifier">n</span>)
    <span class="ruby-keyword">begin</span>
      <span class="ruby-operator">::</span><span class="ruby-constant">Object</span>.<span class="ruby-identifier">const_get</span>(<span class="ruby-identifier">to_s</span>)
    <span class="ruby-keyword">rescue</span> <span class="ruby-constant">NameError</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-node">&quot;Undefined class #{to_s.inspect}&quot;</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

      <div id="method-i-resolve_ivar" class="method-detail ">
        <div class="method-header">
          <div class="method-heading">
            <span class="method-name">resolve_ivar</span><span
              class="method-args">(klass, name)</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
        </div>

        <div class="method-description">
          

          <div class="method-source-code" id="resolve_ivar-source">
            <pre><span class="ruby-comment"># File lib/rubygems/safe_marshal/visitors/to_ruby.rb, line 301</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">resolve_ivar</span>(<span class="ruby-identifier">klass</span>, <span class="ruby-identifier">name</span>)
  <span class="ruby-identifier">to_s</span> = <span class="ruby-identifier">resolve_symbol_name</span>(<span class="ruby-identifier">name</span>)

  <span class="ruby-identifier">raise</span> <span class="ruby-constant">UnpermittedIvarError</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value">symbol:</span> <span class="ruby-identifier">to_s</span>, <span class="ruby-value">klass:</span> <span class="ruby-identifier">klass</span>, <span class="ruby-value">stack:</span> <span class="ruby-identifier">formatted_stack</span>) <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@permitted_ivars</span>.<span class="ruby-identifier">fetch</span>(<span class="ruby-identifier">klass</span>.<span class="ruby-identifier">name</span>, [].<span class="ruby-identifier">freeze</span>).<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">to_s</span>)

  <span class="ruby-identifier">visit_symbol_type</span>(<span class="ruby-identifier">name</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

      <div id="method-i-resolve_symbol_name" class="method-detail ">
        <div class="method-header">
          <div class="method-heading">
            <span class="method-name">resolve_symbol_name</span><span
              class="method-args">(element)</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
        </div>

        <div class="method-description">
          

          <div class="method-source-code" id="resolve_symbol_name-source">
            <pre><span class="ruby-comment"># File lib/rubygems/safe_marshal/visitors/to_ruby.rb, line 322</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">resolve_symbol_name</span>(<span class="ruby-identifier">element</span>)
  <span class="ruby-keyword">case</span> <span class="ruby-identifier">element</span>
  <span class="ruby-keyword">when</span> <span class="ruby-constant">Elements</span><span class="ruby-operator">::</span><span class="ruby-constant">Symbol</span>
    <span class="ruby-identifier">element</span>.<span class="ruby-identifier">name</span>
  <span class="ruby-keyword">when</span> <span class="ruby-constant">Elements</span><span class="ruby-operator">::</span><span class="ruby-constant">SymbolLink</span>
    <span class="ruby-identifier">visit_Gem_SafeMarshal_Elements_SymbolLink</span>(<span class="ruby-identifier">element</span>).<span class="ruby-identifier">name</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">FormatError</span>, <span class="ruby-node">&quot;Expected symbol or symbol link, got #{element.inspect} @ #{formatted_stack.join(&quot;.&quot;)}&quot;</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

      <div id="method-i-visit_Gem_SafeMarshal_Elements_Array" class="method-detail ">
        <div class="method-header">
          <div class="method-heading">
            <span class="method-name">visit_Gem_SafeMarshal_Elements_Array</span><span
              class="method-args">(a)</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
        </div>

        <div class="method-description">
          

          <div class="method-source-code" id="visit_Gem_SafeMarshal_Elements_Array-source">
            <pre><span class="ruby-comment"># File lib/rubygems/safe_marshal/visitors/to_ruby.rb, line 40</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">visit_Gem_SafeMarshal_Elements_Array</span>(<span class="ruby-identifier">a</span>)
  <span class="ruby-identifier">array</span> = <span class="ruby-identifier">register_object</span>([])

  <span class="ruby-identifier">elements</span> = <span class="ruby-identifier">a</span>.<span class="ruby-identifier">elements</span>
  <span class="ruby-identifier">size</span> = <span class="ruby-identifier">elements</span>.<span class="ruby-identifier">size</span>
  <span class="ruby-identifier">idx</span> = <span class="ruby-value">0</span>
  <span class="ruby-comment"># not idiomatic, but there&#39;s a huge number of IMEMOs allocated here, so we avoid the block</span>
  <span class="ruby-comment"># because this is such a hot path when doing a bundle install with the full index</span>
  <span class="ruby-keyword">until</span> <span class="ruby-identifier">idx</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">size</span>
    <span class="ruby-identifier">push_stack</span> <span class="ruby-identifier">idx</span>
    <span class="ruby-identifier">array</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">visit</span>(<span class="ruby-identifier">elements</span>[<span class="ruby-identifier">idx</span>])
    <span class="ruby-identifier">idx</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">array</span>
<span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

      <div id="method-i-visit_Gem_SafeMarshal_Elements_Bignum" class="method-detail ">
        <div class="method-header">
          <div class="method-heading">
            <span class="method-name">visit_Gem_SafeMarshal_Elements_Bignum</span><span
              class="method-args">(b)</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
        </div>

        <div class="method-description">
          

          <div class="method-source-code" id="visit_Gem_SafeMarshal_Elements_Bignum-source">
            <pre><span class="ruby-comment"># File lib/rubygems/safe_marshal/visitors/to_ruby.rb, line 234</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">visit_Gem_SafeMarshal_Elements_Bignum</span>(<span class="ruby-identifier">b</span>)
  <span class="ruby-identifier">result</span> = <span class="ruby-value">0</span>
  <span class="ruby-identifier">b</span>.<span class="ruby-identifier">data</span>.<span class="ruby-identifier">each_byte</span>.<span class="ruby-identifier">with_index</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">byte</span>, <span class="ruby-identifier">exp</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">result</span> <span class="ruby-operator">+=</span> (<span class="ruby-identifier">byte</span> <span class="ruby-operator">*</span> <span class="ruby-value">2</span><span class="ruby-operator">**</span>(<span class="ruby-identifier">exp</span> <span class="ruby-operator">*</span> <span class="ruby-value">8</span>))
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">case</span> <span class="ruby-identifier">b</span>.<span class="ruby-identifier">sign</span>
  <span class="ruby-keyword">when</span> <span class="ruby-value">43</span> <span class="ruby-comment"># ?+</span>
    <span class="ruby-identifier">result</span>
  <span class="ruby-keyword">when</span> <span class="ruby-value">45</span> <span class="ruby-comment"># ?-</span>
    <span class="ruby-operator">-</span><span class="ruby-identifier">result</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">FormatError</span>, <span class="ruby-node">&quot;Unexpected sign for Bignum #{b.sign.chr.inspect} (#{b.sign})&quot;</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

      <div id="method-i-visit_Gem_SafeMarshal_Elements_False" class="method-detail ">
        <div class="method-header">
          <div class="method-heading">
            <span class="method-name">visit_Gem_SafeMarshal_Elements_False</span><span
              class="method-args">(_)</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
        </div>

        <div class="method-description">
          

          <div class="method-source-code" id="visit_Gem_SafeMarshal_Elements_False-source">
            <pre><span class="ruby-comment"># File lib/rubygems/safe_marshal/visitors/to_ruby.rb, line 213</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">visit_Gem_SafeMarshal_Elements_False</span>(<span class="ruby-identifier">_</span>)
  <span class="ruby-keyword">false</span>
<span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

      <div id="method-i-visit_Gem_SafeMarshal_Elements_Float" class="method-detail ">
        <div class="method-header">
          <div class="method-heading">
            <span class="method-name">visit_Gem_SafeMarshal_Elements_Float</span><span
              class="method-args">(f)</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
        </div>

        <div class="method-description">
          

          <div class="method-source-code" id="visit_Gem_SafeMarshal_Elements_Float-source">
            <pre><span class="ruby-comment"># File lib/rubygems/safe_marshal/visitors/to_ruby.rb, line 221</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">visit_Gem_SafeMarshal_Elements_Float</span>(<span class="ruby-identifier">f</span>)
  <span class="ruby-keyword">case</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">string</span>
  <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;inf&quot;</span>
    <span class="ruby-operator">::</span><span class="ruby-constant">Float</span><span class="ruby-operator">::</span><span class="ruby-constant">INFINITY</span>
  <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;-inf&quot;</span>
    <span class="ruby-operator">-</span><span class="ruby-operator">::</span><span class="ruby-constant">Float</span><span class="ruby-operator">::</span><span class="ruby-constant">INFINITY</span>
  <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;nan&quot;</span>
    <span class="ruby-operator">::</span><span class="ruby-constant">Float</span><span class="ruby-operator">::</span><span class="ruby-constant">NAN</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">f</span>.<span class="ruby-identifier">string</span>.<span class="ruby-identifier">to_f</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

      <div id="method-i-visit_Gem_SafeMarshal_Elements_Hash" class="method-detail ">
        <div class="method-header">
          <div class="method-heading">
            <span class="method-name">visit_Gem_SafeMarshal_Elements_Hash</span><span
              class="method-args">(o)</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
        </div>

        <div class="method-description">
          

          <div class="method-source-code" id="visit_Gem_SafeMarshal_Elements_Hash-source">
            <pre><span class="ruby-comment"># File lib/rubygems/safe_marshal/visitors/to_ruby.rb, line 149</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">visit_Gem_SafeMarshal_Elements_Hash</span>(<span class="ruby-identifier">o</span>)
  <span class="ruby-identifier">hash</span> = <span class="ruby-identifier">register_object</span>({})

  <span class="ruby-identifier">o</span>.<span class="ruby-identifier">pairs</span>.<span class="ruby-identifier">each_with_index</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span>(<span class="ruby-identifier">k</span>, <span class="ruby-identifier">v</span>), <span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">push_stack</span> <span class="ruby-identifier">i</span>
    <span class="ruby-identifier">k</span> = <span class="ruby-identifier">visit</span>(<span class="ruby-identifier">k</span>)
    <span class="ruby-identifier">push_stack</span> <span class="ruby-identifier">k</span>
    <span class="ruby-identifier">hash</span>[<span class="ruby-identifier">k</span>] = <span class="ruby-identifier">visit</span>(<span class="ruby-identifier">v</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">hash</span>
<span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

      <div id="method-i-visit_Gem_SafeMarshal_Elements_HashWithDefaultValue" class="method-detail ">
        <div class="method-header">
          <div class="method-heading">
            <span class="method-name">visit_Gem_SafeMarshal_Elements_HashWithDefaultValue</span><span
              class="method-args">(o)</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
        </div>

        <div class="method-description">
          

          <div class="method-source-code" id="visit_Gem_SafeMarshal_Elements_HashWithDefaultValue-source">
            <pre><span class="ruby-comment"># File lib/rubygems/safe_marshal/visitors/to_ruby.rb, line 162</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">visit_Gem_SafeMarshal_Elements_HashWithDefaultValue</span>(<span class="ruby-identifier">o</span>)
  <span class="ruby-identifier">hash</span> = <span class="ruby-identifier">visit_Gem_SafeMarshal_Elements_Hash</span>(<span class="ruby-identifier">o</span>)
  <span class="ruby-identifier">push_stack</span> <span class="ruby-value">:default</span>
  <span class="ruby-identifier">hash</span>.<span class="ruby-identifier">default</span> = <span class="ruby-identifier">visit</span>(<span class="ruby-identifier">o</span>.<span class="ruby-identifier">default</span>)
  <span class="ruby-identifier">hash</span>
<span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

      <div id="method-i-visit_Gem_SafeMarshal_Elements_Integer" class="method-detail ">
        <div class="method-header">
          <div class="method-heading">
            <span class="method-name">visit_Gem_SafeMarshal_Elements_Integer</span><span
              class="method-args">(i)</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
        </div>

        <div class="method-description">
          

          <div class="method-source-code" id="visit_Gem_SafeMarshal_Elements_Integer-source">
            <pre><span class="ruby-comment"># File lib/rubygems/safe_marshal/visitors/to_ruby.rb, line 201</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">visit_Gem_SafeMarshal_Elements_Integer</span>(<span class="ruby-identifier">i</span>)
  <span class="ruby-identifier">i</span>.<span class="ruby-identifier">int</span>
<span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

      <div id="method-i-visit_Gem_SafeMarshal_Elements_Nil" class="method-detail ">
        <div class="method-header">
          <div class="method-heading">
            <span class="method-name">visit_Gem_SafeMarshal_Elements_Nil</span><span
              class="method-args">(_)</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
        </div>

        <div class="method-description">
          

          <div class="method-source-code" id="visit_Gem_SafeMarshal_Elements_Nil-source">
            <pre><span class="ruby-comment"># File lib/rubygems/safe_marshal/visitors/to_ruby.rb, line 205</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">visit_Gem_SafeMarshal_Elements_Nil</span>(<span class="ruby-identifier">_</span>)
  <span class="ruby-keyword">nil</span>
<span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

      <div id="method-i-visit_Gem_SafeMarshal_Elements_Object" class="method-detail ">
        <div class="method-header">
          <div class="method-heading">
            <span class="method-name">visit_Gem_SafeMarshal_Elements_Object</span><span
              class="method-args">(o)</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
        </div>

        <div class="method-description">
          

          <div class="method-source-code" id="visit_Gem_SafeMarshal_Elements_Object-source">
            <pre><span class="ruby-comment"># File lib/rubygems/safe_marshal/visitors/to_ruby.rb, line 169</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">visit_Gem_SafeMarshal_Elements_Object</span>(<span class="ruby-identifier">o</span>)
  <span class="ruby-identifier">register_object</span>(<span class="ruby-identifier">resolve_class</span>(<span class="ruby-identifier">o</span>.<span class="ruby-identifier">name</span>).<span class="ruby-identifier">allocate</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

      <div id="method-i-visit_Gem_SafeMarshal_Elements_ObjectLink" class="method-detail ">
        <div class="method-header">
          <div class="method-heading">
            <span class="method-name">visit_Gem_SafeMarshal_Elements_ObjectLink</span><span
              class="method-args">(o)</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
        </div>

        <div class="method-description">
          

          <div class="method-source-code" id="visit_Gem_SafeMarshal_Elements_ObjectLink-source">
            <pre><span class="ruby-comment"># File lib/rubygems/safe_marshal/visitors/to_ruby.rb, line 173</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">visit_Gem_SafeMarshal_Elements_ObjectLink</span>(<span class="ruby-identifier">o</span>)
  <span class="ruby-ivar">@objects</span>[<span class="ruby-identifier">o</span>.<span class="ruby-identifier">offset</span>]
<span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

      <div id="method-i-visit_Gem_SafeMarshal_Elements_String" class="method-detail ">
        <div class="method-header">
          <div class="method-heading">
            <span class="method-name">visit_Gem_SafeMarshal_Elements_String</span><span
              class="method-args">(s)</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
        </div>

        <div class="method-description">
          

          <div class="method-source-code" id="visit_Gem_SafeMarshal_Elements_String-source">
            <pre><span class="ruby-comment"># File lib/rubygems/safe_marshal/visitors/to_ruby.rb, line 217</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">visit_Gem_SafeMarshal_Elements_String</span>(<span class="ruby-identifier">s</span>)
  <span class="ruby-identifier">register_object</span>(<span class="ruby-operator">+</span><span class="ruby-identifier">s</span>.<span class="ruby-identifier">str</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

      <div id="method-i-visit_Gem_SafeMarshal_Elements_Symbol" class="method-detail ">
        <div class="method-header">
          <div class="method-heading">
            <span class="method-name">visit_Gem_SafeMarshal_Elements_Symbol</span><span
              class="method-args">(s)</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
        </div>

        <div class="method-description">
          

          <div class="method-source-code" id="visit_Gem_SafeMarshal_Elements_Symbol-source">
            <pre><span class="ruby-comment"># File lib/rubygems/safe_marshal/visitors/to_ruby.rb, line 57</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">visit_Gem_SafeMarshal_Elements_Symbol</span>(<span class="ruby-identifier">s</span>)
  <span class="ruby-identifier">name</span> = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">name</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">UnpermittedSymbolError</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value">symbol:</span> <span class="ruby-identifier">name</span>, <span class="ruby-value">stack:</span> <span class="ruby-identifier">formatted_stack</span>) <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@permitted_symbols</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">name</span>)
  <span class="ruby-identifier">visit_symbol_type</span>(<span class="ruby-identifier">s</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

      <div id="method-i-visit_Gem_SafeMarshal_Elements_SymbolLink" class="method-detail ">
        <div class="method-header">
          <div class="method-heading">
            <span class="method-name">visit_Gem_SafeMarshal_Elements_SymbolLink</span><span
              class="method-args">(o)</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
        </div>

        <div class="method-description">
          

          <div class="method-source-code" id="visit_Gem_SafeMarshal_Elements_SymbolLink-source">
            <pre><span class="ruby-comment"># File lib/rubygems/safe_marshal/visitors/to_ruby.rb, line 177</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">visit_Gem_SafeMarshal_Elements_SymbolLink</span>(<span class="ruby-identifier">o</span>)
  <span class="ruby-ivar">@symbols</span>[<span class="ruby-identifier">o</span>.<span class="ruby-identifier">offset</span>]
<span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

      <div id="method-i-visit_Gem_SafeMarshal_Elements_True" class="method-detail ">
        <div class="method-header">
          <div class="method-heading">
            <span class="method-name">visit_Gem_SafeMarshal_Elements_True</span><span
              class="method-args">(_)</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
        </div>

        <div class="method-description">
          

          <div class="method-source-code" id="visit_Gem_SafeMarshal_Elements_True-source">
            <pre><span class="ruby-comment"># File lib/rubygems/safe_marshal/visitors/to_ruby.rb, line 209</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">visit_Gem_SafeMarshal_Elements_True</span>(<span class="ruby-identifier">_</span>)
  <span class="ruby-keyword">true</span>
<span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

      <div id="method-i-visit_Gem_SafeMarshal_Elements_UserClass" class="method-detail ">
        <div class="method-header">
          <div class="method-heading">
            <span class="method-name">visit_Gem_SafeMarshal_Elements_UserClass</span><span
              class="method-args">(r)</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
        </div>

        <div class="method-description">
          

          <div class="method-source-code" id="visit_Gem_SafeMarshal_Elements_UserClass-source">
            <pre><span class="ruby-comment"># File lib/rubygems/safe_marshal/visitors/to_ruby.rb, line 250</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">visit_Gem_SafeMarshal_Elements_UserClass</span>(<span class="ruby-identifier">r</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">resolve_class</span>(<span class="ruby-identifier">r</span>.<span class="ruby-identifier">name</span>) <span class="ruby-operator">==</span> <span class="ruby-operator">::</span><span class="ruby-constant">Hash</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">r</span>.<span class="ruby-identifier">wrapped_object</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Elements</span><span class="ruby-operator">::</span><span class="ruby-constant">Hash</span>)

    <span class="ruby-identifier">hash</span> = <span class="ruby-identifier">register_object</span>({}.<span class="ruby-identifier">compare_by_identity</span>)

    <span class="ruby-identifier">o</span> = <span class="ruby-identifier">r</span>.<span class="ruby-identifier">wrapped_object</span>
    <span class="ruby-identifier">o</span>.<span class="ruby-identifier">pairs</span>.<span class="ruby-identifier">each_with_index</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span>(<span class="ruby-identifier">k</span>, <span class="ruby-identifier">v</span>), <span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">push_stack</span> <span class="ruby-identifier">i</span>
      <span class="ruby-identifier">k</span> = <span class="ruby-identifier">visit</span>(<span class="ruby-identifier">k</span>)
      <span class="ruby-identifier">push_stack</span> <span class="ruby-identifier">k</span>
      <span class="ruby-identifier">hash</span>[<span class="ruby-identifier">k</span>] = <span class="ruby-identifier">visit</span>(<span class="ruby-identifier">v</span>)
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Elements</span><span class="ruby-operator">::</span><span class="ruby-constant">HashWithDefaultValue</span>)
      <span class="ruby-identifier">push_stack</span> <span class="ruby-value">:default</span>
      <span class="ruby-identifier">hash</span>.<span class="ruby-identifier">default</span> = <span class="ruby-identifier">visit</span>(<span class="ruby-identifier">o</span>.<span class="ruby-identifier">default</span>)
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">hash</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">UnsupportedError</span>.<span class="ruby-identifier">new</span>(<span class="ruby-node">&quot;Unsupported user class #{resolve_class(r.name)} in marshal stream&quot;</span>, <span class="ruby-value">stack:</span> <span class="ruby-identifier">formatted_stack</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

      <div id="method-i-visit_Gem_SafeMarshal_Elements_UserDefined" class="method-detail ">
        <div class="method-header">
          <div class="method-heading">
            <span class="method-name">visit_Gem_SafeMarshal_Elements_UserDefined</span><span
              class="method-args">(o)</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
        </div>

        <div class="method-description">
          

          <div class="method-source-code" id="visit_Gem_SafeMarshal_Elements_UserDefined-source">
            <pre><span class="ruby-comment"># File lib/rubygems/safe_marshal/visitors/to_ruby.rb, line 181</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">visit_Gem_SafeMarshal_Elements_UserDefined</span>(<span class="ruby-identifier">o</span>)
  <span class="ruby-identifier">register_object</span>(<span class="ruby-identifier">call_method</span>(<span class="ruby-identifier">resolve_class</span>(<span class="ruby-identifier">o</span>.<span class="ruby-identifier">name</span>), <span class="ruby-value">:_load</span>, <span class="ruby-identifier">o</span>.<span class="ruby-identifier">binary_string</span>))
<span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

      <div id="method-i-visit_Gem_SafeMarshal_Elements_UserMarshal" class="method-detail ">
        <div class="method-header">
          <div class="method-heading">
            <span class="method-name">visit_Gem_SafeMarshal_Elements_UserMarshal</span><span
              class="method-args">(o)</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
        </div>

        <div class="method-description">
          

          <div class="method-source-code" id="visit_Gem_SafeMarshal_Elements_UserMarshal-source">
            <pre><span class="ruby-comment"># File lib/rubygems/safe_marshal/visitors/to_ruby.rb, line 185</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">visit_Gem_SafeMarshal_Elements_UserMarshal</span>(<span class="ruby-identifier">o</span>)
  <span class="ruby-identifier">klass</span> = <span class="ruby-identifier">resolve_class</span>(<span class="ruby-identifier">o</span>.<span class="ruby-identifier">name</span>)
  <span class="ruby-identifier">compat</span> = <span class="ruby-constant">COMPAT_CLASSES</span>.<span class="ruby-identifier">fetch</span>(<span class="ruby-identifier">klass</span>, <span class="ruby-keyword">nil</span>)
  <span class="ruby-identifier">idx</span> = <span class="ruby-ivar">@objects</span>.<span class="ruby-identifier">size</span>
  <span class="ruby-identifier">object</span> = <span class="ruby-identifier">register_object</span>(<span class="ruby-identifier">call_method</span>(<span class="ruby-identifier">compat</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">klass</span>, <span class="ruby-value">:allocate</span>))

  <span class="ruby-identifier">push_stack</span> <span class="ruby-value">:data</span>
  <span class="ruby-identifier">ret</span> = <span class="ruby-identifier">call_method</span>(<span class="ruby-identifier">object</span>, <span class="ruby-value">:marshal_load</span>, <span class="ruby-identifier">visit</span>(<span class="ruby-identifier">o</span>.<span class="ruby-identifier">data</span>))

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">compat</span>
    <span class="ruby-identifier">object</span> = <span class="ruby-ivar">@objects</span>[<span class="ruby-identifier">idx</span>] = <span class="ruby-identifier">ret</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">object</span>
<span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

      <div id="method-i-visit_Gem_SafeMarshal_Elements_WithIvars" class="method-detail ">
        <div class="method-header">
          <div class="method-heading">
            <span class="method-name">visit_Gem_SafeMarshal_Elements_WithIvars</span><span
              class="method-args">(e)</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
        </div>

        <div class="method-description">
          

          <div class="method-source-code" id="visit_Gem_SafeMarshal_Elements_WithIvars-source">
            <pre><span class="ruby-comment"># File lib/rubygems/safe_marshal/visitors/to_ruby.rb, line 79</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">visit_Gem_SafeMarshal_Elements_WithIvars</span>(<span class="ruby-identifier">e</span>)
  <span class="ruby-identifier">object_offset</span> = <span class="ruby-ivar">@objects</span>.<span class="ruby-identifier">size</span>
  <span class="ruby-identifier">push_stack</span> <span class="ruby-string">&quot;object&quot;</span>
  <span class="ruby-identifier">object</span> = <span class="ruby-identifier">visit</span>(<span class="ruby-identifier">e</span>.<span class="ruby-identifier">object</span>)
  <span class="ruby-identifier">ivars</span> = <span class="ruby-identifier">map_ivars</span>(<span class="ruby-identifier">object</span>.<span class="ruby-identifier">class</span>, <span class="ruby-identifier">e</span>.<span class="ruby-identifier">ivars</span>)

  <span class="ruby-keyword">case</span> <span class="ruby-identifier">e</span>.<span class="ruby-identifier">object</span>
  <span class="ruby-keyword">when</span> <span class="ruby-constant">Elements</span><span class="ruby-operator">::</span><span class="ruby-constant">UserDefined</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">object</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-operator">::</span><span class="ruby-constant">Time</span>
      <span class="ruby-identifier">internal</span> = []

      <span class="ruby-identifier">ivars</span>.<span class="ruby-identifier">reject!</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">k</span>, <span class="ruby-identifier">v</span><span class="ruby-operator">|</span>
        <span class="ruby-keyword">case</span> <span class="ruby-identifier">k</span>
        <span class="ruby-keyword">when</span> <span class="ruby-value">:offset</span>, <span class="ruby-value">:zone</span>, <span class="ruby-value">:nano_num</span>, <span class="ruby-value">:nano_den</span>, <span class="ruby-value">:submicro</span>
          <span class="ruby-identifier">internal</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-identifier">k</span>, <span class="ruby-identifier">v</span>]
          <span class="ruby-keyword">true</span>
        <span class="ruby-keyword">else</span>
          <span class="ruby-keyword">false</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-identifier">s</span> = <span class="ruby-identifier">e</span>.<span class="ruby-identifier">object</span>.<span class="ruby-identifier">binary_string</span>

      <span class="ruby-identifier">marshal_string</span> = <span class="ruby-string">&quot;\x04\bIu:\tTime&quot;</span>.<span class="ruby-identifier">b</span>
      <span class="ruby-identifier">marshal_string</span>.<span class="ruby-identifier">concat</span>(<span class="ruby-identifier">s</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">+</span> <span class="ruby-value">5</span>)
      <span class="ruby-identifier">marshal_string</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">s</span>
      <span class="ruby-identifier">marshal_string</span>.<span class="ruby-identifier">concat</span>(<span class="ruby-identifier">internal</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">+</span> <span class="ruby-value">5</span>)

      <span class="ruby-identifier">internal</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">k</span>, <span class="ruby-identifier">v</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">marshal_string</span>.<span class="ruby-identifier">concat</span>(<span class="ruby-string">&quot;:&quot;</span>)
        <span class="ruby-identifier">marshal_string</span>.<span class="ruby-identifier">concat</span>(<span class="ruby-identifier">k</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">+</span> <span class="ruby-value">5</span>)
        <span class="ruby-identifier">marshal_string</span>.<span class="ruby-identifier">concat</span>(<span class="ruby-identifier">k</span>.<span class="ruby-identifier">to_s</span>)
        <span class="ruby-identifier">dumped</span> = <span class="ruby-constant">Marshal</span>.<span class="ruby-identifier">dump</span>(<span class="ruby-identifier">v</span>)
        <span class="ruby-identifier">dumped</span>[<span class="ruby-value">0</span>, <span class="ruby-value">2</span>] = <span class="ruby-string">&quot;&quot;</span>
        <span class="ruby-identifier">marshal_string</span>.<span class="ruby-identifier">concat</span>(<span class="ruby-identifier">dumped</span>)
      <span class="ruby-keyword">end</span>

      <span class="ruby-identifier">object</span> = <span class="ruby-ivar">@objects</span>[<span class="ruby-identifier">object_offset</span>] = <span class="ruby-constant">Marshal</span>.<span class="ruby-identifier">load</span>(<span class="ruby-identifier">marshal_string</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">when</span> <span class="ruby-constant">Elements</span><span class="ruby-operator">::</span><span class="ruby-constant">String</span>
    <span class="ruby-identifier">enc</span> = <span class="ruby-keyword">nil</span>

    <span class="ruby-identifier">ivars</span>.<span class="ruby-identifier">reject!</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">k</span>, <span class="ruby-identifier">v</span><span class="ruby-operator">|</span>
      <span class="ruby-keyword">case</span> <span class="ruby-identifier">k</span>
      <span class="ruby-keyword">when</span> <span class="ruby-value">:E</span>
        <span class="ruby-keyword">case</span> <span class="ruby-identifier">v</span>
        <span class="ruby-keyword">when</span> <span class="ruby-constant">TrueClass</span>
          <span class="ruby-identifier">enc</span> = <span class="ruby-string">&quot;UTF-8&quot;</span>
        <span class="ruby-keyword">when</span> <span class="ruby-constant">FalseClass</span>
          <span class="ruby-identifier">enc</span> = <span class="ruby-string">&quot;US-ASCII&quot;</span>
        <span class="ruby-keyword">else</span>
          <span class="ruby-identifier">raise</span> <span class="ruby-constant">FormatError</span>, <span class="ruby-node">&quot;Unexpected value for String :E #{v.inspect}&quot;</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">when</span> <span class="ruby-value">:encoding</span>
        <span class="ruby-identifier">enc</span> = <span class="ruby-identifier">v</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-keyword">next</span> <span class="ruby-keyword">false</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">true</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">object</span>.<span class="ruby-identifier">force_encoding</span>(<span class="ruby-identifier">enc</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">enc</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">ivars</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">k</span>, <span class="ruby-identifier">v</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">object</span>.<span class="ruby-identifier">instance_variable_set</span> <span class="ruby-identifier">k</span>, <span class="ruby-identifier">v</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">object</span>
<span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

      <div id="method-i-visit_symbol_type" class="method-detail ">
        <div class="method-header">
          <div class="method-heading">
            <span class="method-name">visit_symbol_type</span><span
              class="method-args">(element)</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
        </div>

        <div class="method-description">
          

          <div class="method-source-code" id="visit_symbol_type-source">
            <pre><span class="ruby-comment"># File lib/rubygems/safe_marshal/visitors/to_ruby.rb, line 309</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">visit_symbol_type</span>(<span class="ruby-identifier">element</span>)
  <span class="ruby-keyword">case</span> <span class="ruby-identifier">element</span>
  <span class="ruby-keyword">when</span> <span class="ruby-constant">Elements</span><span class="ruby-operator">::</span><span class="ruby-constant">Symbol</span>
    <span class="ruby-identifier">sym</span> = <span class="ruby-identifier">element</span>.<span class="ruby-identifier">name</span>.<span class="ruby-identifier">to_sym</span>
    <span class="ruby-ivar">@symbols</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">sym</span>
    <span class="ruby-identifier">sym</span>
  <span class="ruby-keyword">when</span> <span class="ruby-constant">Elements</span><span class="ruby-operator">::</span><span class="ruby-constant">SymbolLink</span>
    <span class="ruby-identifier">visit_Gem_SafeMarshal_Elements_SymbolLink</span>(<span class="ruby-identifier">element</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

    </section>

  </section>
</main>


<footer id="validator-badges" role="contentinfo">
  <p><a href="https://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="https://ruby.github.io/rdoc/">RDoc</a> 6.6.3.1.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-RDoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

